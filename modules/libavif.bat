@echo off && call %PATH_MODULES_COMMON%\init.bat %1 cmake

REM AVIF_CODEC_AOM - requires CMake, NASM
REM AVIF_CODEC_DAV1D - requires Meson, Ninja, NASM
REM AVIF_CODEC_LIBGAV1 - requires CMake, Ninja
REM AVIF_CODEC_RAV1E - requires cargo (Rust), NASM

if "%ARG_CMOPTS%"=="1" (@echo on)
cmake %CMAKE_OPTS% -G %CMAKE_TGT_NINJA% ^
-DCMAKE_INSTALL_PREFIX=%PATH_INSTALL% ^
-DAVIF_CODEC_AOM=SYSTEM ^
-DAVIF_CODEC_AVM=OFF ^
-DAVIF_CODEC_DAV1D=SYSTEM ^
-DAVIF_CODEC_LIBGAV1=SYSTEM ^
-DAVIF_CODEC_RAV1E=OFF ^
-DAVIF_CODEC_SVT=OFF ^
-DAVIF_ENABLE_COMPLIANCE_WARDEN=OFF ^
-DAVIF_ENABLE_EXPERIMENTAL_SAMPLE_TRANSFORM=OFF ^
-DAVIF_ENABLE_NODISCARD=OFF ^
-DAVIF_ENABLE_WERROR=OFF ^
-DAVIF_ENABLE_EXPERIMENTAL_EXTENDED_PIXI=OFF ^
-DAVIF_ENABLE_EXPERIMENTAL_MINI=OFF ^
-DAVIF_ENABLE_GOLDEN_TESTS=OFF ^
-DAVIF_ZLIBPNG=SYSTEM ^
-DAVIF_JPEG=SYSTEM ^
-DAVIF_LIBXML2=SYSTEM ^
-DLIBXML2_INCLUDE_DIR=%PATH_INSTALL%\include\libxml2 ^
-DLIBXML2_LIBRARY=%PATH_INSTALL%\lib\libxml2.lib ^
-DAVIF_LIBYUV=SYSTEM ^
-DLIBYUV_INCLUDE_DIR=%PATH_INSTALL%\include\ ^
-DLIBYUV_LIBRARY=%PATH_INSTALL%\lib\libyuv.lib ^
-DFETCHCONTENT_FULLY_DISCONNECTED=OFF ^
-DFETCHCONTENT_QUIET=OFF ^
-DFETCHCONTENT_UPDATES_DISCONNECTED=OFF ^
-DBUILD_SHARED_LIBS=ON ^
-DAVIF_BUILD_APPS=OFF ^
-DAVIF_BUILD_TESTS=OFF ^
-DAVIF_GTEST=OFF ^
-DAVIF_FUZZTEST=OFF ^
%PATH_SRC%\%1
@echo off
if "%ARG_CMOPTS%"=="1" (exit /B)

%PATH_BIN_CYGWIN%\bash %CYGPATH_MODULES_COMMON%/ninja.sh "%AVX%" "%CYGPATH_BUILD%/%1" "%NUMBER_OF_PROCESSORS%"
sed -i 's/DWIN32/DWIN32 \/DLIBYUV_USING_SHARED_LIBRARY=1/g' %CYGPATH_BUILD%/%1/build.ninja
%NINJA% install

	REM -DAVIF_BUILD_APPS=ON > avifenc.exe avifdec.exe
for %%X in (avif.dll) do (
	xcopy /C /F /Y %PATH_BUILD%\%1\%%~nX.pdb %PATH_INSTALL%\bin\*
	call do_php %PATH_UTILS%\sub\version.php %1 %PATH_INSTALL%\bin\%%X
)