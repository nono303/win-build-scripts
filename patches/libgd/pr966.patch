From 7bf249c9dd02a50e709a7625f806c6f58945cf32 Mon Sep 17 00:00:00 2001
From: David Carlier <devnexen@gmail.com>
Date: Sat, 6 Sep 2025 21:17:38 +0100
Subject: [PATCH 1/2] gdTransformAffineBoundingBox() fix UB overflow.

ref: https://github.com/php/php-src/issues/19730
---
 src/gd_interpolation.c | 12 ++++++++++--
 1 file changed, 10 insertions(+), 2 deletions(-)

diff --git a/src/gd_interpolation.c b/src/gd_interpolation.c
index f1c151ef7..3f30ab8b4 100644
--- a/src/gd_interpolation.c
+++ b/src/gd_interpolation.c
@@ -2179,10 +2179,18 @@ BGD_DECLARE(int) gdTransformAffineBoundingBox(gdRectPtr src, const double affine
 		if (max.y < extent[i].y)
 			max.y=extent[i].y;
 	}
+	double twidth = ceil((max.x - min.x));
+	double theight = ceil(max.y - min.y);
+
+	if (twidth < (double)INT_MIN || twidth > (double)INT_MAX)
+		twidth = 0.0;
+	if (theight < (double)INT_MIN || theight > (double)INT_MAX)
+		theight = 0.0;
+
 	bbox->x = (int) min.x;
 	bbox->y = (int) min.y;
-	bbox->width  = (int) ceil((max.x - min.x));
-	bbox->height = (int) ceil(max.y - min.y);
+	bbox->width  = (int) twidth;
+	bbox->height = (int) theight;
 
 	return GD_TRUE;
 }

From d2bb5fedd3fd0cb351a2b295a287db619680c0ab Mon Sep 17 00:00:00 2001
From: David Carlier <devnexen@gmail.com>
Date: Sat, 13 Sep 2025 12:05:44 +0100
Subject: [PATCH 2/2] add test

---
 .../gdtransformaffinegetimage/CMakeLists.txt  |  5 ++++
 tests/gdtransformaffinegetimage/Makemodule.am |  5 ++++
 tests/gdtransformaffinegetimage/gh966.c       | 25 +++++++++++++++++++
 3 files changed, 35 insertions(+)
 create mode 100644 tests/gdtransformaffinegetimage/CMakeLists.txt
 create mode 100644 tests/gdtransformaffinegetimage/Makemodule.am
 create mode 100644 tests/gdtransformaffinegetimage/gh966.c

diff --git a/tests/gdtransformaffinegetimage/CMakeLists.txt b/tests/gdtransformaffinegetimage/CMakeLists.txt
new file mode 100644
index 000000000..2aa12e71e
--- /dev/null
+++ b/tests/gdtransformaffinegetimage/CMakeLists.txt
@@ -0,0 +1,5 @@
+LIST(APPEND TESTS_FILES
+	gh966
+)
+
+ADD_GD_TESTS()
diff --git a/tests/gdtransformaffinegetimage/Makemodule.am b/tests/gdtransformaffinegetimage/Makemodule.am
new file mode 100644
index 000000000..2193ff41a
--- /dev/null
+++ b/tests/gdtransformaffinegetimage/Makemodule.am
@@ -0,0 +1,5 @@
+libgd_test_programs += \
+	gdtransformaffinegetimage/gh966
+
+EXTRA_DIST += \
+	gdtransformaffinegetimage/CMakeLists.txt
diff --git a/tests/gdtransformaffinegetimage/gh966.c b/tests/gdtransformaffinegetimage/gh966.c
new file mode 100644
index 000000000..3a9776a7c
--- /dev/null
+++ b/tests/gdtransformaffinegetimage/gh966.c
@@ -0,0 +1,25 @@
+#include "gd.h"
+
+#include "gdtest.h"
+#include <limits.h>
+
+
+int main()
+{
+		gdImagePtr im, d;
+		gdRect rect;
+		double affine[6];
+
+		affine[0] = INT_MAX;
+		affine[1] = 1;
+		affine[2] = 1;
+		affine[3] =  1;
+		affine[4] =  1;
+		affine[5] =  1;
+
+		im = gdImageCreateTrueColor(8, 8);
+		gdTransformAffineGetImage(&d, im, &rect, affine);
+
+		return 0;
+}
+
