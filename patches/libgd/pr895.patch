From 5108de7578f23edc5599464f49f5a43d376162b5 Mon Sep 17 00:00:00 2001
From: Martin Rodriguez Reboredo <yakoyoku@gmail.com>
Date: Sun, 27 Oct 2024 11:21:28 -0300
Subject: [PATCH 1/3] Declare macro for thread local storage variables

---
 src/gdhelpers.h | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/src/gdhelpers.h b/src/gdhelpers.h
index 9b187af7f..1b0b91870 100644
--- a/src/gdhelpers.h
+++ b/src/gdhelpers.h
@@ -12,6 +12,24 @@ extern "C" {
 #include <stdlib.h>
 #endif /* _WIN32_WCE */
 
+#if defined(_WIN32) || defined(CYGWIN) || defined(_WIN32_WCE)
+# ifdef __GNUC__
+#  if (__STDC_VERSION__ >= 201112L)
+#   define BGD_THREAD_LOCAL _Thread_local
+#  else
+#   define BGD_THREAD_LOCAL __thread
+#  endif
+# else
+#  define BGD_THREAD_LOCAL __declspec(thread)
+# endif
+#else
+# if (__STDC_VERSION__ >= 201112L)
+#  define BGD_THREAD_LOCAL _Thread_local
+# else
+#  define BGD_THREAD_LOCAL __thread
+# endif
+#endif
+
 /* TBB: strtok_r is not universal; provide an implementation of it. */
 
 char *gd_strtok_r(char *s, const char *sep, char **state);

From df22ee6e86e595edc0aa0ff65b66a041e5a340d2 Mon Sep 17 00:00:00 2001
From: Martin Rodriguez Reboredo <yakoyoku@gmail.com>
Date: Sat, 26 Oct 2024 11:30:59 -0300
Subject: [PATCH 2/3] Revise HEIF read test comment

---
 tests/heif/heif_read.c | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/tests/heif/heif_read.c b/tests/heif/heif_read.c
index 6ecb5f09b..112959162 100644
--- a/tests/heif/heif_read.c
+++ b/tests/heif/heif_read.c
@@ -1,6 +1,5 @@
 /**
- * Simple test case that confirms the failure of using `gdImageCreateFromHeif`
- * with a NULL pointer.
+ * Simple test case that checks reading images using `gdImageCreateFromHeif`.
  */
 
 

From 8ab7191ea0fc7b6259241709232162c0f5bfe440 Mon Sep 17 00:00:00 2001
From: Martin Rodriguez Reboredo <yakoyoku@gmail.com>
Date: Thu, 24 Oct 2024 15:11:39 -0300
Subject: [PATCH 3/3] Implement libheif initialization

---
 src/gd.h      |  4 ++++
 src/gd_heif.c | 49 +++++++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 53 insertions(+)

diff --git a/src/gd.h b/src/gd.h
index b03323889..c078b2632 100644
--- a/src/gd.h
+++ b/src/gd.h
@@ -382,6 +382,10 @@ typedef const char *gdHeifChroma;
 #define GD_HEIF_CHROMA_422 "422"
 #define GD_HEIF_CHROMA_444 "444"
 
+BGD_DECLARE(int) gdHeifInit();
+
+BGD_DECLARE(void) gdHeifDeinit();
+
 /* define struct with name and func ptr and add it to gdImageStruct gdInterpolationMethod interpolation; */
 
 /* Interpolation function ptr */
diff --git a/src/gd_heif.c b/src/gd_heif.c
index adccbabed..3e383e7f3 100644
--- a/src/gd_heif.c
+++ b/src/gd_heif.c
@@ -23,6 +23,8 @@
 #define GD_HEIF_ALLOC_STEP (4*1024)
 #define GD_HEIF_HEADER 12
 
+static BGD_THREAD_LOCAL int heifInit = 0;
+
 typedef enum gd_heif_brand {
 	GD_HEIF_BRAND_AVIF = 1,
 	GD_HEIF_BRAND_MIF1 = 2,
@@ -30,6 +32,43 @@ typedef enum gd_heif_brand {
 	GD_HEIF_BRAND_HEIX = 8,
 } gd_heif_brand;
 
+/*
+  Function: gdHeifInit
+
+    Initialize libheif, no need to call manually because other HEIF
+    functions do so.
+
+  Returns:
+
+    On success 0 is returned, otherwise 1 on error.
+*/
+BGD_DECLARE(int) gdHeifInit()
+{
+	if (heifInit)
+		return 0;
+	struct heif_error err = heif_init(NULL);
+	if (err.code != heif_error_Ok)
+		return 1;
+	heifInit = 1;
+	return 0;
+}
+
+/*
+  Function: gdHeifInit
+
+    Deinitialize libheif, call this whenever is not longer needed to
+    handle HEIF images.
+*/
+BGD_DECLARE(void) gdHeifDeinit()
+{
+	if (!heifInit) {
+		gd_error("gd-heif invalid library deinitialization");
+		return;
+	}
+	heif_deinit();
+	heifInit = 0;
+}
+
 /*
   Function: gdImageCreateFromHeif
 
@@ -135,6 +174,11 @@ static gdImagePtr _gdImageCreateFromHeifCtx(gdIOCtx *infile, gd_heif_brand expec
 	}
 	gdSeek(infile, 0);
 
+	if (gdHeifInit()) {
+		gd_error("gd-heif failure to initialize library");
+		return GD_FALSE;
+	}
+
 	while (n == GD_HEIF_ALLOC_STEP) {
 		temp = gdRealloc(filedata, size + GD_HEIF_ALLOC_STEP);
 		if (temp) {
@@ -301,6 +345,11 @@ static int _gdImageHeifCtx(gdImagePtr im, gdIOCtx *outfile, int quality, gdHeifC
 		return GD_FALSE;
 	}
 
+	if (gdHeifInit()) {
+		gd_error("Failure to initialize heif library");
+		return GD_FALSE;
+	}
+
 	heif_ctx = heif_context_alloc();
 	if (heif_ctx == NULL) {
 		gd_error("gd-heif could not allocate context\n");
